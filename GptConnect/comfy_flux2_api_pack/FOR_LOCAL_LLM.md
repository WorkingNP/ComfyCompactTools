# ローカルLLM向け：レビュー＆修正タスク指示書（必読）

あなたはこのリポジトリの「修正担当AI」です。以下を厳守してください。

目的
- ComfyUI をキャンバス操作せずに、ローカルAPI（/prompt → /history → /view）だけで
  - FLUX.2 dev
  - FLUX.2 [klein] 4B FP8（distilled / base）
  の画像生成が、エラーなく安定して行える状態にする。

最重要ルール（テスト駆動）
1) **実装修正の前に、必ずテストを用意すること。**
   - 既に `tests/` があるが、不十分なら必ず補強すること。
2) **修正は「テストが通るまで」繰り返すこと。**
   - 途中で「たぶん動く」では止めない。`pytest` が成功するまで反復。
3) テストは「このリポジトリのワークフロー（テンプレprompt JSON＋スクリプト）」を使って、
   **実際に画像ファイルが出力されたこと**を検証すること。
   - 少なくとも：出力ファイルが存在する / 0バイトではない / Pillowで画像として開ける。
   - 可能なら：サイズが指定通り（例 512x512）であることも確認する。

制約（勝手に変えない）
- ComfyUI上で手作業のノード組みを前提にしないこと（＝このリポジトリだけで完結させる）。
- ワークフローは **ComfyUIのコアノード** で構成されている前提を崩さないこと（不用意にカスタムノード前提にしない）。
- 依存関係は最小に（requests / Pillow / pytest 程度）。重いフレームワークを増やさない。

推奨作業手順
A. 現状把握
- `pytest -q` を実行し、失敗箇所・エラーメッセージを整理する
- ComfyUI のURLは `COMFY_BASE_URL` を参照しているので、必要なら設定してから実行

B. テストの強化（最初にやる）
- 失敗時に「ComfyUIが起動していない」「モデルが無い」「ノードが無い」等の原因が分かるよう、
  エラーメッセージを改善する（テスト or 実装どちらでも良いが、まずテスト観点で改善する）
- 可能なら `/object_info` でノード存在チェック、`/models/...` でモデル存在チェックも行う

C. 実装修正（テストが通るまで反復）
- タイムアウト、リトライ、例外メッセージ、テンプレのノードID整合性などを改善
- `--width/--height/--steps/--cfg/--seed` 等の上書きが確実に効くことを確認
- 生成が完了しても画像が取れないケース（historyにimagesが無い）を解析し、メッセージを改善

D. 完了条件
- `pytest -q` が成功（`RUN_KLEIN_BASE_TESTS=1` を付けた場合も成功が望ましい）
- READMEの手順で、手動生成も問題なく動く

コマンド
```bash
pip install -r requirements.txt
pytest -q

# klein base も回す場合
RUN_KLEIN_BASE_TESTS=1 pytest -q
```
