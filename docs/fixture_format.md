# Fixture Capture Format

This document describes the output format of `scripts/capture_fixtures.py`.

## Directory Structure

```
<output_dir>/<timestamp>_<workflow_id>/
├── capture_meta.json     # Capture metadata
├── request.json          # Job request payload
├── object_info.json      # ComfyUI node definitions (optional)
├── job_response.json     # Initial job creation response
├── job_final.json        # Final job state
├── assets.json           # Asset metadata (success only)
├── sample_output.png     # Generated image (success only)
└── error_summary.txt     # Error details (failure only)
```

## File Descriptions

### capture_meta.json

Metadata about the capture session.

```json
{
  "workflow_id": "flux2_klein_distilled",
  "timestamp": "2025-01-23T12:34:56.789012",
  "timestamp_unix": 1737632096.789012,
  "status": "completed",
  "job_id": "abc123-def456",
  "errors": [],
  "duration_seconds": 15.5
}
```

| Field | Type | Description |
|-------|------|-------------|
| `workflow_id` | string | The workflow ID being tested |
| `timestamp` | string | ISO 8601 timestamp of capture start |
| `timestamp_unix` | number | Unix timestamp of capture start |
| `status` | string | One of: `completed`, `failed`, `timeout` |
| `job_id` | string | Job ID from cockpit server (may be null if job creation failed) |
| `errors` | array | List of error messages encountered |
| `duration_seconds` | number | Total capture duration in seconds |

### request.json

The job request payload sent to the cockpit server.

```json
{
  "prompt": "a cute cat sitting on a windowsill",
  "workflow_id": "flux2_klein_distilled",
  "width": 512,
  "height": 512,
  "steps": 4
}
```

### object_info.json

ComfyUI's `/object_info` response containing all available node definitions.
This file is large (~5MB) and is useful for debugging node availability issues.

### job_response.json

Initial response from job creation.

```json
{
  "id": "abc123-def456",
  "status": "queued",
  "created_at": "2025-01-23T12:34:56.000000"
}
```

### job_final.json

Final job state after completion or failure.

**Success:**
```json
{
  "id": "abc123-def456",
  "status": "completed",
  "created_at": "2025-01-23T12:34:56.000000",
  "completed_at": "2025-01-23T12:35:10.000000"
}
```

**Failure:**
```json
{
  "id": "abc123-def456",
  "status": "failed",
  "error": "ComfyUI execution error: Node X not found",
  "created_at": "2025-01-23T12:34:56.000000"
}
```

### assets.json

List of assets generated by the job (success only).

```json
[
  {
    "id": "asset_001",
    "job_id": "abc123-def456",
    "url": "/assets/2025-01-23/flux2_klein_distilled_00001_.png",
    "filename": "flux2_klein_distilled_00001_.png",
    "created_at": "2025-01-23T12:35:10.000000"
  }
]
```

### sample_output.png

The actual generated image (success only).

### error_summary.txt

Human-readable error summary (failure only).

```
Capture Failed: flux2_klein_distilled
Timestamp: 2025-01-23T12:34:56.789012
Job ID: abc123-def456
==================================================

Error 1:
Job failed: ComfyUI execution error: Node X not found
```

## Usage

### Capture Fixtures

```bash
# Create timestamped capture directory
python scripts/capture_fixtures.py \
  --workflow-id flux2_klein_distilled \
  --prompt "a cute cat" \
  --output tests/fixtures/

# Use output directory directly (no timestamp subdirectory)
python scripts/capture_fixtures.py \
  --workflow-id flux2_klein_distilled \
  --prompt "a cute cat" \
  --output tests/fixtures/klein_test/ \
  --no-timestamp
```

### Debugging Failures

When a capture fails, check:

1. `capture_meta.json` - See `status` and `errors` fields
2. `error_summary.txt` - Human-readable error details
3. `object_info.json` - Check if required nodes are available
4. `job_final.json` - Check job error message

### Using Fixtures in Tests

Fixtures can be used for offline testing without ComfyUI:

```python
import json
from pathlib import Path

def test_workflow_output():
    fixture_dir = Path("tests/fixtures/20250123_123456_flux2_klein_distilled")

    # Load capture metadata
    with open(fixture_dir / "capture_meta.json") as f:
        meta = json.load(f)

    assert meta["status"] == "completed"

    # Load and verify request
    with open(fixture_dir / "request.json") as f:
        request = json.load(f)

    # Check generated image
    image_path = fixture_dir / "sample_output.png"
    assert image_path.exists()
```

## Status Values

| Status | Description |
|--------|-------------|
| `in_progress` | Capture is still running (shouldn't appear in final output) |
| `completed` | Job completed successfully and image was downloaded |
| `failed` | Job failed or an error occurred during capture |
| `timeout` | Job did not complete within the timeout period |
